<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Index</title>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
</head>
<body class="bg-primary-subtle">
    <div class="container">
                
        <div class="row-gap-md-5 ">

            <div class="col-md bg-white p-3 mt-5 rounded" id="form_container">
                
                    <h1 class="text-dark text-center">Add expence</h1><br>

                    <form >
                        <div class="form-floating">
                            <input type="number" name="amount" id="amount" required class="form-control" placeholder="m">
                            <label for="amount" class="form-label">Enter expence amount:</label><br>
                        </div>
                        <div class="form-floating">
                            <input type="text" name="description" id="description" required class="form-control" placeholder="m" >
                            <label for="description" class="form-label">Description:</label><br>
                        </div>

                        <select name="category" id="category" required class="form-select" >
                            <option value="" selected>Choose category</option>
                            <option value="Food">Food</option>
                            <option value="Fuel">Fuel</option>
                            <option value="Lifestyle">Lifestyle</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Travelling">Travelling</option>
                        </select><br>
                        
                        <button class="btn btn-success" type="submit" id="submit" >Add Expence</button>
                        
                    </form>
                        
                </div>
        </div>
        <table class="table table-hover bg-white mt-2 text-center rounded">
            <thead class="bg-success-subtle"><th>Amount</th><th>Description</th><th>Category</th><th> </th></thead>
            <tbody id = "tbody"></tbody>
        </table>
        <h3 id="h3"></h3>
        <table class="table table-hover bg-white mt-2 text-center rounded">
            <thead id="LeaderboardHead" class="bg-success-subtle"></thead>
            <tbody id = "LeaderboardBody"></tbody>
        </table>
        
    </div>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://unpkg.com/axios@1.1.2/dist/axios.min.js"> </script>
    <script>
        const isPremiumUser = localStorage.getItem('isPremiumUser');
        const token = localStorage.getItem('token');

        const form_container = document.getElementById('form_container');

            if(isPremiumUser === 'true'){
                const LeaderboardBody = document.getElementById('LeaderboardBody');
                const LeaderboardHead = document.getElementById('LeaderboardHead');

                const showLeaderboard = document.createElement('button');
                showLeaderboard.className = "btn btn-outline-primary mt-2";
                showLeaderboard.textContent = "Show Leaderboard";

                showLeaderboard.addEventListener('click', async()=>{
                    LeaderboardBody.innerHTML='';
                    LeaderboardHead.innerHTML='';
                    const h3 = document.getElementById('h3');
                    const nameth = document.createElement('th');
                    const totalAmountth = document.createElement('th');

                    h3.className = "text-dark text-center";
                    h3.textContent = 'Leaderboard';
                    nameth.textContent = 'Name'; 
                    totalAmountth.textContent = 'Total Amount';

                    LeaderboardHead.appendChild(nameth);
                    LeaderboardHead.appendChild(totalAmountth);

                    const res = await axios.get("http://localhost:3000/premium/showLeaderboard",{headers : {'Auth' : token}});
                    console.log(res);
                    res.data.forEach(data =>{
                        
                        const tr = document.createElement('tr');
                        const td1 = document.createElement('td');
                        const td2 = document.createElement('td');

                        td1.textContent = data.name;
                        if(data.totalExpence != null){
                            td2.textContent = data.totalExpence;
                        }else{
                            td2.textContent = 0;
                        }
                        
                        tr.appendChild(td1);
                        tr.appendChild(td2);

                        LeaderboardBody.appendChild(tr);

                    });
                    
                });

                form_container.appendChild(showLeaderboard);



            }else{
                const buyPremium = document.createElement('button');
                buyPremium.className = "btn btn-outline-primary mt-2";
                buyPremium.textContent = "Buy Premium";

                buyPremium.addEventListener('click',async (e)=>{
                    const res = await axios.get("http://localhost:3000/purchase/primiumMembership",{headers : {'Auth' : token}});
                    var options = {
                        "key" : res.data.key_id,
                        "order_id" : res.data.order.id,
                        "handler" : async function (responce) {
                            await axios.post("http://localhost:3000/purchase/updateStatus",{
                                orderId : options.order_id,
                                paymentId : responce.razorpay_payment_id
                            },{ headers : {'Auth' : token}})
                            localStorage.setItem('isPremiumUser', true);
                            location.reload();
                        }
                    };
                    const rzp1 = new Razorpay(options);
                    rzp1.open();
                    e.preventDefault();

                    rzp1.on('payment.failed', function(responce){
                        console.log(responce);
                        alert("somthing went wrong!")
                    })
                } );

                form_container.appendChild(buyPremium);
            }

        if(token){
            const amount = document.querySelector("#amount");
            const description = document.querySelector("#description");
            const category = document.querySelector("#category");
            const tbody = document.getElementById('tbody');
            const submit = document.querySelector("#submit");

            submit.addEventListener('click',async ()=>{
                event.preventDefault();
                const obj = {'amount':amount.value,'description':description.value,'category':category.value, 'token': token};
                try{
                    const res = await axios.post("http://localhost:3000/expence/addExpence",obj);
                    display();
                }
                catch(err){console.log(err)};

            });

            async function display(){

                const res = await axios.get("http://localhost:3000/expence/getExpence", { headers : {'Auth' : token}});
                
                tbody.innerHTML='';

                
                    res.data.forEach(data => {
                        const tr = document.createElement('tr');
                        const td1 = document.createElement('td');
                        const td2 = document.createElement('td');
                        const td3 = document.createElement('td');
                        const td4 = document.createElement('td');
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'btn btn-danger btn-sm';
                        deleteBtn.textContent='Delete';
                        deleteBtn.addEventListener('click',async ()=>{
                            try{
                                await axios.delete(`http://localhost:3000/expence/deleteExpence/${data.id}`);
                                tbody.removeChild(tr);
                            }catch(err){console.log(err)};
                            
                        });

                        td1.textContent=`${data.amount}`; 
                        td2.textContent=`${data.description}`; 
                        td3.textContent=`${data.category}`; 
                        td4.appendChild(deleteBtn);

                        tr.appendChild(td1);
                        tr.appendChild(td2);
                        tr.appendChild(td3);
                        tr.appendChild(td4);
                        tbody.appendChild(tr);
                        
                    });
                

            };
            display();


        }
        else{location.replace('login.html')}
        
        
        
    </script>
</body>
</html>